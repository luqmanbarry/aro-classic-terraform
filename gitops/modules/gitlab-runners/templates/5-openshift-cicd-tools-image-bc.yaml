---
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: openshift-cicd-tools
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
spec: {}
---
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: openshift-cicd-tools
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "5"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
spec:
  successfulBuildsHistoryLimit: 3
  failedBuildsHistoryLimit: 3
  runPolicy: Serial
  source:
    dockerfile: |-
      FROM {{ .Values.runnerBaseImage }}

      RUN echo "==> Installing GoLang" && \
          dnf install -y go-toolset golang-docs

      RUN echo "==> Installilng Terraform" && \
          yum install -y yum-utils && \
          yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo && \
          yum -y install terraform

      RUN echo "==> Installing Azure CLI" && \
          rpm --import https://packages.microsoft.com/keys/microsoft.asc && \
          dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm && \
          dnf install -y azure-cli

      RUN echo "==> Installing helm" && \
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
          chmod 700 get_helm.sh && \
          ./get_helm.sh && \
          helm version

      RUN echo "Installing JQ" && \
          yum install -y epel-release && \
          yum install -y jq

      RUN echo "==> Checking for oc, helm, jq programs" && \
          oc version --client && \
          helm version && \
          jq --version

  output:
    to:
      kind: ImageStreamTag
      name: openshift-cicd-tools:latest

  strategy:
    dockerStrategy:
      forcePull: true

  triggers:
    - type: "ConfigChange"
    - type: "Generic"
      generic:
        secretReference:
          name: "openshift-cicd-tools"
        allowEnv: true
---
apiVersion: batch/v1
kind: Job
metadata:
  name: openshift-cicd-tools-bc-trigger
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "4"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
spec:
  completions: 1
  parallelism: 1
  ttlSecondsAfterFinished: 100
  template:
    spec:
      serviceAccount: openshift-gitops-argocd-application-controller
      containers:
        - name: openshift-cicd-tools-bc-trigger
          image: image-registry.openshift-image-registry.svc:5000/openshift/cli
          env:
            - name: BUILD_CONFIG_NAME
              value: openshift-cicd-tools

          command:
            - /bin/sh
            - -c
            - |-
              echo "Triggering the BuildConfig: '$BUILD_CONFIG_NAME'"
              sleep 15
              API_SERVER=$(oc whoami --show-server)
              curl -X POST -k $API_SERVER/apis/build.openshift.io/v1/namespaces/{{ .Values.namespace }}/buildconfigs/$BUILD_CONFIG_NAME/webhooks/$BUILD_CONFIG_NAME/generic
      restartPolicy: OnFailure
  backoffLimit: 3
---