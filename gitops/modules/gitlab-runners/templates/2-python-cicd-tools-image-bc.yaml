# Used for the python-cicd-tools runner - Duplicate this file to add other runners
---
apiVersion: image.openshift.io/v1
kind: ImageStream
metadata:
  name: python-cicd-tools
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
  labels:
    app.kubernetes.io/part-of: {{ .Values.namespace }}
spec: {}
---
apiVersion: build.openshift.io/v1
kind: BuildConfig
metadata:
  name: python-cicd-tools
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
  labels:
    app.kubernetes.io/part-of: {{ .Values.namespace }}
spec:
  successfulBuildsHistoryLimit: 3
  failedBuildsHistoryLimit: 3
  runPolicy: SerialLatestOnly
  source:
    dockerfile: |-
      FROM {{ .Values.runnerBuildImage }}

      RUN echo "==> Installing Azure CLI" && \
          dnf update -y && \
          rpm --import https://packages.microsoft.com/keys/microsoft.asc && \
          dnf install -y https://packages.microsoft.com/config/rhel/9.0/packages-microsoft-prod.rpm && \
          dnf install -y azure-cli

      RUN echo "==> Installing helm" && \
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 && \
          chmod 700 get_helm.sh && \
          ./get_helm.sh && \
          helm version

      RUN echo "Installing JQ" && \
          dnf install -y jq && \
          jq --version

      RUN echo "==> Installing python3.12 and packages" && \
          subscription-manager repos --enable codeready-builder-for-rhel-9-x86_64-rpms && \
          dnf install -y python3.12 python3-requests dnf install python3.12-Cython python3.12-pip && \
          dnf install -y pipx && \
          pipx ensurepath --global && \
          pip3.12 install ansible kubernetes jsonpatch pyyaml jmespath kubernetes-validate openshift openshift-client

      RUN echo "==> Checking for oc, helm, jq programs" && \
          oc version --client && \
          helm version && \
          jq --version && \
          pipx --version

  output:
    to:
      kind: ImageStreamTag
      name: python-cicd-tools:latest

  strategy:
    dockerStrategy:
      forcePull: true

  triggers:
    - type: "Generic"
      generic:
        secretReference:
          name: "python-cicd-tools"
        allowEnv: true
---
kind: Secret
apiVersion: v1
metadata:
  name: "python-cicd-tools"
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
  labels:
    app.kubernetes.io/part-of: {{ .Values.namespace }}
stringData:
  WebHookSecretKey: python-cicd-tools
---
apiVersion: batch/v1
kind: Job
metadata:
  name: python-cicd-tools-bc-trigger
  namespace: {{ .Values.namespace }}
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "2"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
  labels:
    app.kubernetes.io/part-of: {{ .Values.namespace }}
spec:
  completions: 1
  parallelism: 1
  ttlSecondsAfterFinished: 100
  template:
    spec:
      containers:
        - name: python-cicd-tools-bc-trigger
          image: image-registry.openshift-image-registry.svc:5000/openshift/cli
          env:
            - name: BUILD_CONFIG_NAME
              value: "python-cicd-tools"
          command:
            - /bin/sh
            - -c
            - |-
              echo "Triggering the BuildConfig: '$BUILD_CONFIG_NAME'"
              sleep 15
              API_SERVER=$(oc whoami --show-server)
              curl -X POST -k "$API_SERVER/apis/build.openshift.io/v1/namespaces/{{ .Values.namespace }}/buildconfigs/$BUILD_CONFIG_NAME/webhooks/$BUILD_CONFIG_NAME/generic"
      restartPolicy: OnFailure
  backoffLimit: 3
---