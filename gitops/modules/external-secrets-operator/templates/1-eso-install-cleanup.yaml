---
apiVersion: batch/v1
kind: Job
metadata:
  name: "eso-install-cleanup"
  namespace: openshift-gitops
  annotations:
    managed-by: argocd.argoproj.io
    argocd.argoproj.io/sync-wave: "1"
    argocd.argoproj.io/sync-options: "SkipDryRunOnMissingResource=true"
spec:
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  template:
    spec:
      serviceAccountName: openshift-gitops-argocd-application-controller
      serviceAccount: openshift-gitops-argocd-application-controller
      restartPolicy: OnFailure
      containers:
      - name: "eso-install-cleanup"
        image: registry.redhat.io/openshift4/ose-tools-rhel9
        securityContext:
          allowPrivilegeEscalation: false
          seccompProfile:
            type: "RuntimeDefault"
          capabilities:
            drop: [ALL]
        command:
        - /bin/sh
        - -c
        - |
            set -e
            echo "Cleanup install namespace"
            oc delete -n {{ .Values.namespace }} clusterserviceversion --all || true
            oc delete -n {{ .Values.namespace }} subscription --all || true
            oc delete -n {{ .Values.namespace }} operatorgroup --all || true
            oc delete -n {{ .Values.namespace }} installplan --all || true

            echo "Deleting all instacnes of ESO operands"
            oc delete ClusterExternalSecret --all --all-namespaces || true
            oc delete ClusterSecretStore --all --all-namespaces || true
            oc delete ExternalSecret --all --all-namespaces || true
            oc delete OperatorConfig --all --all-namespaces || true
            oc delete SecretStore --all --all-namespaces || true
            oc delete ExternalSecret --all --all-namespaces || true

            echo "Deleting all CRDs associated"
            oc delete CustomResourceDefinitions/ClusterExternalSecret || true
            oc delete CustomResourceDefinitions/ClusterSecretStore || true
            oc delete CustomResourceDefinitions/ExternalSecret || true
            oc delete CustomResourceDefinitions/OperatorConfig || true
            oc delete CustomResourceDefinitions/SecretStore || true
            oc delete CustomResourceDefinitions/Webhook || true